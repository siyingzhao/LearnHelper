import { i18n } from '@lingui/core';
import { generateMessageId } from '@lingui/message-utils/generateMessageId';

import { STORAGE_KEY_LANGUAGE } from './constants';
import { messages as messagesEN } from './locales/en.po';
import { messages as messagesZH } from './locales/zh.po';

export type Language = 'zh' | 'en';

const FALLBACK_ZH = [
  '学习统计',
  '课程',
  '作业标题',
  '提交时间',
  '作业提交统计',
  '当前学期：',
  '最后更新时间：',
  '作业总数',
  '已提交',
  '提交率',
  '夜间提交占比',
  '周末提交占比',
  '逾期提交占比',
  '未提交作业',
  '临近截止占比',
  '含附件作业',
  '附件总大小',
  '活跃提交天数',
  '最长连续提交',
  '平均提前提交',
  '提交日历热力图',
  '提交时间热力图（周-小时）',
  '提交时间线（本学期）',
  '提交时段分布（小时）',
  '提交星期分布',
  '截止前提交分布',
  '未提交作业风险分布',
  '附件大小分布',
  '最近提交',
  '暂无提交记录',
  '暂无数据',
  '请先登录后查看统计',
  '个人拖延画像',
  '横轴为小时，纵轴为星期',
  '最近16周，颜色越深表示提交次数越多',
  '截止前6小时',
  '截止前24小时',
  '夜间提交',
  '周末提交',
  '逾期提交',
  '超前型',
  '提前规划，很少拖延',
  '极限型',
  '常在最后时刻提交',
  '冲刺型',
  '多在截止前提交',
  '临界型',
  '停停催催，偶尔压线',
  '稳健型',
  '节奏稳定，成品率高',
  '周日',
  '周一',
  '周二',
  '周三',
  '周四',
  '周五',
  '周六',
  '逾期',
  '0-6小时',
  '6-24小时',
  '1-3天',
  '3天以上',
  '<6小时',
];

const FALLBACK_EN: Record<string, string> = {
  '学习统计': 'Learning analytics',
  '课程': 'Course',
  '作业标题': 'Assignment title',
  '提交时间': 'Submitted at',
  '作业提交统计': 'Assignment submission stats',
  '当前学期：': 'Current semester:',
  '最后更新时间：': 'Last updated:',
  '作业总数': 'Total assignments',
  '已提交': 'Submitted',
  '提交率': 'Submission rate',
  '夜间提交占比': 'Night share',
  '周末提交占比': 'Weekend share',
  '逾期提交占比': 'Late share',
  '未提交作业': 'Unsubmitted assignments',
  '临近截止占比': 'Near-deadline share',
  '含附件作业': 'With attachments',
  '附件总大小': 'Total attachment size',
  '活跃提交天数': 'Active days',
  '最长连续提交': 'Longest streak',
  '平均提前提交': 'Avg lead time',
  '提交日历热力图': 'Submission calendar heatmap',
  '提交时间热力图（周-小时）': 'Submission heatmap (weekday-hour)',
  '提交时间线（本学期）': 'Submission timeline (semester)',
  '提交时段分布（小时）': 'Submission by hour',
  '提交星期分布': 'Submission by weekday',
  '截止前提交分布': 'Lead time distribution',
  '未提交作业风险分布': 'Unsubmitted risk distribution',
  '附件大小分布': 'Attachment size distribution',
  '最近提交': 'Recent submissions',
  '暂无提交记录': 'No submission records',
  '暂无数据': 'No data',
  '请先登录后查看统计': 'Please log in to view stats',
  '个人拖延画像': 'Procrastination profile',
  '横轴为小时，纵轴为星期': 'X-axis: hour, Y-axis: weekday',
  '最近16周，颜色越深表示提交次数越多': 'Last 16 weeks, darker means more submissions',
  '截止前6小时': 'Within 6h before deadline',
  '截止前24小时': 'Within 24h before deadline',
  '夜间提交': 'Night submissions',
  '周末提交': 'Weekend submissions',
  '逾期提交': 'Late submissions',
  '超前型': 'Early-bird',
  '提前规划，很少拖延': 'Plans ahead, rarely procrastinates',
  '极限型': 'Extreme',
  '常在最后时刻提交': 'Often at the last moment',
  '冲刺型': 'Sprinter',
  '多在截止前提交': 'Mostly before deadline',
  '临界型': 'Borderline',
  '停停催催，偶尔压线': 'Occasional deadline rush',
  '稳健型': 'Steady',
  '节奏稳定，成品率高': 'Stable pace, high completion',
  '周日': 'Sun',
  '周一': 'Mon',
  '周二': 'Tue',
  '周三': 'Wed',
  '周四': 'Thu',
  '周五': 'Fri',
  '周六': 'Sat',
  '逾期': 'Overdue',
  '0-6小时': '0-6 hours',
  '6-24小时': '6-24 hours',
  '1-3天': '1-3 days',
  '3天以上': '3+ days',
  '<6小时': '<6 hours',
};

const toCatalog = (pairs: Array<[string, string]>) =>
  Object.fromEntries(pairs.map(([key, value]) => [generateMessageId(key), value]));

i18n.load({
  en: { ...messagesEN, ...toCatalog(Object.entries(FALLBACK_EN)) },
  zh: { ...messagesZH, ...toCatalog(FALLBACK_ZH.map((s) => [s, s])) },
});

const { [STORAGE_KEY_LANGUAGE]: storedLanguage } = await browser.storage.local.get([
  STORAGE_KEY_LANGUAGE,
]);
i18n.activate(storedLanguage || new Intl.Locale(browser.i18n.getUILanguage()).language);

i18n.on('change', async () => {
  await browser.storage.local.set({ [STORAGE_KEY_LANGUAGE]: i18n.locale });
});
